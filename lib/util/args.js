const merge=require('./misc').merge;module.exports=a=>new Promise((b,c)=>{let d={commands:[],variables:{}},e={},f={},g={};const h=b=>{for(let c of b)for(let b in a.flags)if(c===b||0<=a.flags[b].indexOf(c)){d[b]=!0;break}};let j=process.argv.slice(2);for(let f=0;f<j.length;f++){let b=j[f],c=b.split('='),g=c.shift().toLowerCase().replace(/^--/,''),i=g in a.variables||c.length;if(i){let b=c.length?c.join('='):j[++f];e[g]=a.variables[g]?(e[g]||[]).concat(b.split(',')):b}else b.startsWith('--')?h([b.slice(2)]):b.startsWith('-')?h(b.slice(1)):d.commands.push(b)}for(let e in d.commands[0]&&(d.commands[0]=a.aliases[d.commands[0]]||d.commands[0]),process.env){let a=e.toLowerCase();a.startsWith('pgb_')&&(a=a.slice(4),f[a]=process.env[e])}if(process.stdin.isTTY)return d.variables=merge(f,e),b(d);let i=[];process.stdin.on('data',a=>i.push(a)),process.stdin.once('end',()=>{let a=i.join('').trim();if(0<a.length)try{g=JSON.parse(a)}catch(a){return c(new Error('piped data is invalid json'))}return d.variables=merge(f,g,e),b(d)})});